name: E2E Tests with Visual Evidence

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop, feature/* ]

jobs:
  e2e-tests:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app
      
    - name: Create Artifacts Directory
      run: |
        cd _macOS/FinanceMate
        mkdir -p test_artifacts
        
    - name: Build FinanceMate
      run: |
        cd _macOS/FinanceMate
        xcodebuild build \
          -project FinanceMate.xcodeproj \
          -scheme FinanceMate \
          -destination 'platform=macOS'
          
    - name: Run E2E Tests with Screenshots
      run: |
        cd _macOS/FinanceMate
        xcodebuild test \
          -project FinanceMate.xcodeproj \
          -scheme FinanceMate \
          -destination 'platform=macOS' \
          -only-testing:FinanceMateTests/AuthenticationE2ETests \
          -resultBundlePath e2e_results.xcresult \
          || true
          
    - name: Run Headless Test Framework
      run: |
        cd _macOS/FinanceMate
        swift FinanceMateTests/HeadlessTestRunner.swift ui-automation
        
    - name: List Captured Screenshots
      run: |
        cd _macOS/FinanceMate
        echo "üì∏ Screenshots captured:"
        ls -la test_artifacts/*.png || echo "No screenshots found"
        
    - name: Upload Screenshots
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: e2e-screenshots
        path: _macOS/FinanceMate/test_artifacts/*.png
        
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          _macOS/FinanceMate/e2e_results.xcresult
          _macOS/FinanceMate/test_output.log
          
    - name: Comment PR with Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          let comment = '## üß™ E2E Test Results\n\n';
          
          // Check if screenshots exist
          const artifactsPath = '_macOS/FinanceMate/test_artifacts';
          if (fs.existsSync(artifactsPath)) {
            const screenshots = fs.readdirSync(artifactsPath).filter(f => f.endsWith('.png'));
            if (screenshots.length > 0) {
              comment += '### üì∏ Screenshots Captured:\n';
              screenshots.forEach(s => {
                comment += `- ‚úÖ ${s}\n`;
              });
            } else {
              comment += '### ‚ö†Ô∏è No screenshots captured\n';
            }
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });